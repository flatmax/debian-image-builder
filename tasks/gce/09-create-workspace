## create-workspace
#
# Prepare safe workspace for GCE files

# Ensure our temporary loopback device and mount get cleaned up no
# matter how we exit, even if it's before the usual cleanup steps.
function cleanup_loopback_mount ()
{
    # Disable exit-on-error
    set +e

    if [ -n "${imagedir}" ]
    then
        log "Unmounting ${imagedir} ahead of unclean exit."
        umount "${imagedir}"
    fi

    if [ -n "${block_device_path}" ]
    then
        log "Deleting loopback device ${block_device_path} ahead of unclean exit."
        losetup -d "${block_device_path}"
    fi

    if [ -d "${workspace}" ]
    then
        log "${workspace} still exists. Leaving alone for potential debugging."
    fi

    # Enable exit-on-error
    set -e
}

add_to_trap cleanup_loopback_mount ERR EXIT

workspace="$(mktemp -d -t ${prog_name}.XXXXXXXXXX)"
tarballdir="${workspace}"
